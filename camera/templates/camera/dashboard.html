{% extends 'camera/base.html' %}

{% block title %}Dashboard - Smart Traffic Light System{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    <p>Real-time traffic monitoring and control system</p>
</div>

<!-- Stats Overview -->
<div class="grid-4" style="margin-bottom: 25px;">
    <div class="stat-box">
        <div class="stat-icon primary">
            <i class="fas fa-cog"></i>
        </div>
        <div class="stat-label">System Mode</div>
        <div class="stat-value" id="systemMode">AUTO</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon success">
            <i class="fas fa-compass"></i>
        </div>
        <div class="stat-label">Active Direction</div>
        <div class="stat-value" id="activeDirection">NORTH</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon warning">
            <i class="fas fa-car"></i>
        </div>
        <div class="stat-label">Total Vehicles</div>
        <div class="stat-value" id="totalVehicles">0</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon danger">
            <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="stat-label">Detector FPS</div>
        <div class="stat-value" id="detectorFPS">0</div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="grid-2" style="margin-bottom: 25px;">
    <!-- Video Feed -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-video"></i>
                Primary Camera (RPi Camera)
            </div>
            <span class="badge badge-success" id="cameraBadge">
                <i class="fas fa-circle"></i> Live
            </span>
        </div>
        <div class="video-container">
            <div class="video-label">
                <i class="fas fa-camera"></i> Camera Module 3
            </div>
            <img id="mainCamera" src="{% url 'camera:video_feed' %}" alt="Main Camera" 
                 onerror="this.style.display='none'" onload="this.style.display='block'">
            <div id="cameraPlaceholder" style="color: var(--text-secondary); display: none;">
                <i class="fas fa-video-slash" style="font-size: 48px;"></i>
                <p style="margin-top: 15px;">Camera not available</p>
            </div>
        </div>
    </div>

    <!-- Traffic Lights -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-traffic-light"></i>
                Traffic Lights Status
            </div>
        </div>
        <div class="traffic-lights-grid">
            <div class="traffic-light-group">
                <div class="traffic-light-title">
                    <i class="fas fa-arrow-up"></i> NORTH
                </div>
                <div class="traffic-light">
                    <div class="light red" id="north-red"></div>
                    <div class="light yellow" id="north-yellow"></div>
                    <div class="light green" id="north-green"></div>
                </div>
                <div class="vehicle-count">
                    <i class="fas fa-car"></i> <span id="north-count">0</span> vehicles
                </div>
                <button class="btn btn-warning" onclick="requestPedestrian('NORTH')" style="width: 100%; font-size: 12px;">
                    <i class="fas fa-walking"></i> Pedestrian
                </button>
            </div>

            <div class="traffic-light-group">
                <div class="traffic-light-title">
                    <i class="fas fa-arrow-right"></i> EAST
                </div>
                <div class="traffic-light">
                    <div class="light red" id="east-red"></div>
                    <div class="light yellow" id="east-yellow"></div>
                    <div class="light green" id="east-green"></div>
                </div>
                <div class="vehicle-count">
                    <i class="fas fa-car"></i> <span id="east-count">0</span> vehicles
                </div>
                <button class="btn btn-warning" onclick="requestPedestrian('EAST')" style="width: 100%; font-size: 12px;">
                    <i class="fas fa-walking"></i> Pedestrian
                </button>
            </div>

            <div class="traffic-light-group">
                <div class="traffic-light-title">
                    <i class="fas fa-arrow-down"></i> SOUTH
                </div>
                <div class="traffic-light">
                    <div class="light red" id="south-red"></div>
                    <div class="light yellow" id="south-yellow"></div>
                    <div class="light green" id="south-green"></div>
                </div>
                <div class="vehicle-count">
                    <i class="fas fa-car"></i> <span id="south-count">0</span> vehicles
                </div>
                <button class="btn btn-warning" onclick="requestPedestrian('SOUTH')" style="width: 100%; font-size: 12px;">
                    <i class="fas fa-walking"></i> Pedestrian
                </button>
            </div>

            <div class="traffic-light-group">
                <div class="traffic-light-title">
                    <i class="fas fa-arrow-left"></i> WEST
                </div>
                <div class="traffic-light">
                    <div class="light red" id="west-red"></div>
                    <div class="light yellow" id="west-yellow"></div>
                    <div class="light green" id="west-green"></div>
                </div>
                <div class="vehicle-count">
                    <i class="fas fa-car"></i> <span id="west-count">0</span> vehicles
                </div>
                <button class="btn btn-warning" onclick="requestPedestrian('WEST')" style="width: 100%; font-size: 12px;">
                    <i class="fas fa-walking"></i> Pedestrian
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel & Chart -->
<div class="grid-2">
    <!-- Control Panel -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-sliders-h"></i>
                Control Panel
            </div>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            <button class="btn btn-primary" onclick="toggleMode()" id="modeBtnContainer">
                <i class="fas fa-sync-alt"></i>
                <span id="modeBtn">Switch to MANUAL</span>
            </button>
            <button class="btn btn-success" onclick="toggleDetection()" id="detectionBtn">
                <i class="fas fa-eye"></i>
                Enable Detection
            </button>
            <button class="btn btn-danger" onclick="emergencyStop()">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Stop
            </button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: var(--bg-input); border-radius: 12px;">
            <h4 style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px; text-transform: uppercase;">
                Quick Info
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                <div>
                    <span style="color: var(--text-secondary);">LED Status:</span>
                    <span id="ledStatus" class="badge badge-success" style="margin-left: 5px;">Active</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">Detection:</span>
                    <span id="detectionStatus" class="badge badge-danger" style="margin-left: 5px;">Off</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">DroidCam:</span>
                    <span id="droidcamStatus" class="badge badge-danger" style="margin-left: 5px;">Disconnected</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">Cycle:</span>
                    <span id="cycleCount" style="font-weight: 600;">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Chart -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-area"></i>
                Vehicle Count History
            </div>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="vehicleChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Events (Compact) -->
<div class="card" style="margin-top: 25px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-history"></i>
            Recent Events
        </div>
        <a href="{% url 'camera:analytics' %}" class="btn btn-outline" style="padding: 8px 16px; font-size: 12px;">
            View All <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    <div class="log-container" id="eventLog" style="max-height: 200px;">
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            <i class="fas fa-spinner fa-spin"></i> Loading events...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentMode = 'AUTO';
    let detectionEnabled = false;
    let vehicleChart = null;
    let maxDataPoints = 20;

    // Initialize Chart
    function initChart() {
        const ctx = document.getElementById('vehicleChart').getContext('2d');
        vehicleChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'NORTH',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'EAST',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'SOUTH',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'WEST',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { 
                            color: '#a0aec0',
                            usePointStyle: true,
                            boxWidth: 8,
                            font: { size: 11 }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#a0aec0', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    x: {
                        ticks: { 
                            color: '#a0aec0', 
                            font: { size: 10 },
                            maxRotation: 0,
                            maxTicksLimit: 8
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Update traffic status
    function updateTrafficStatus() {
        fetch('{% url "camera:traffic_status" %}')
            .then(response => response.json())
            .then(data => {
                // Update system status
                document.getElementById('systemMode').textContent = data.mode;
                document.getElementById('activeDirection').textContent = data.current_direction;
                
                // Update vehicle counts
                let total = 0;
                const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
                directions.forEach(dir => {
                    const count = data.vehicle_counts[dir] || 0;
                    total += count;
                    document.getElementById(`${dir.toLowerCase()}-count`).textContent = count;
                });
                document.getElementById('totalVehicles').textContent = total;

                // Update FPS and detection
                if (data.detector) {
                    document.getElementById('detectorFPS').textContent = Math.round(data.detector.fps);
                    detectionEnabled = data.detector.enabled;
                    
                    const detectionStatus = document.getElementById('detectionStatus');
                    if (detectionEnabled) {
                        detectionStatus.className = 'badge badge-success';
                        detectionStatus.textContent = 'Active';
                        document.getElementById('detectionBtn').innerHTML = '<i class="fas fa-eye-slash"></i> Disable Detection';
                    } else {
                        detectionStatus.className = 'badge badge-danger';
                        detectionStatus.textContent = 'Off';
                        document.getElementById('detectionBtn').innerHTML = '<i class="fas fa-eye"></i> Enable Detection';
                    }
                }

                // Update traffic lights
                updateTrafficLights(data.led_states);

                // Update chart (limited data points)
                updateChart(data.vehicle_counts);

                // Update mode button
                currentMode = data.mode;
                document.getElementById('modeBtn').textContent = 
                    data.mode === 'AUTO' ? 'Switch to MANUAL' : 'Switch to AUTO';
            })
            .catch(error => console.error('Error fetching traffic status:', error));
    }

    // Update traffic light indicators
    function updateTrafficLights(ledStates) {
        const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
        
        directions.forEach(dir => {
            const state = ledStates[dir] || 'RED';
            const dirLower = dir.toLowerCase();
            
            // Reset all lights
            ['red', 'yellow', 'green'].forEach(color => {
                document.getElementById(`${dirLower}-${color}`).classList.remove('active');
            });
            
            // Activate appropriate light(s)
            if (state === 'RED') {
                document.getElementById(`${dirLower}-red`).classList.add('active');
            } else if (state === 'YELLOW') {
                document.getElementById(`${dirLower}-yellow`).classList.add('active');
            } else if (state === 'GREEN') {
                document.getElementById(`${dirLower}-green`).classList.add('active');
            } else if (state === 'RED_YELLOW') {
                document.getElementById(`${dirLower}-red`).classList.add('active');
                document.getElementById(`${dirLower}-yellow`).classList.add('active');
            }
        });
    }

    // Update chart with fixed data points
    function updateChart(vehicleCounts) {
        if (!vehicleChart) return;

        const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        // Add new data point
        vehicleChart.data.labels.push(now);
        vehicleChart.data.datasets[0].data.push(vehicleCounts.NORTH || 0);
        vehicleChart.data.datasets[1].data.push(vehicleCounts.EAST || 0);
        vehicleChart.data.datasets[2].data.push(vehicleCounts.SOUTH || 0);
        vehicleChart.data.datasets[3].data.push(vehicleCounts.WEST || 0);

        // Keep only last N points
        while (vehicleChart.data.labels.length > maxDataPoints) {
            vehicleChart.data.labels.shift();
            vehicleChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        vehicleChart.update('none');
    }

    // Update event log
    function updateEventLog() {
        fetch('{% url "camera:event_log" %}?limit=10')
            .then(response => response.json())
            .then(data => {
                const eventLog = document.getElementById('eventLog');
                
                if (data.events && data.events.length > 0) {
                    eventLog.innerHTML = data.events.reverse().map(event => {
                        const iconClass = getEventIcon(event.type);
                        return `
                            <div class="log-entry ${event.type.toLowerCase()}">
                                <div class="log-icon ${event.type.toLowerCase()}">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div class="log-content">
                                    <div class="log-time">${event.timestamp}</div>
                                    <div class="log-message">${event.message}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    eventLog.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-secondary);">No events yet</div>';
                }
            })
            .catch(error => console.error('Error fetching events:', error));
    }

    function getEventIcon(type) {
        const icons = {
            'system': 'fa-cog',
            'pedestrian': 'fa-walking',
            'transition': 'fa-exchange-alt',
            'emergency': 'fa-exclamation-triangle',
            'car': 'fa-car',
            'led': 'fa-lightbulb'
        };
        return icons[type.toLowerCase()] || 'fa-info-circle';
    }

    // Control functions
    function toggleMode() {
        const newMode = currentMode === 'AUTO' ? 'MANUAL' : 'AUTO';
        
        fetch('{% url "camera:set_traffic_mode" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: newMode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTrafficStatus();
            }
        })
        .catch(error => console.error('Error toggling mode:', error));
    }

    function toggleDetection() {
        fetch('{% url "camera:toggle_detection" %}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                updateTrafficStatus();
            })
            .catch(error => console.error('Error toggling detection:', error));
    }

    function emergencyStop() {
        if (confirm('‚ö†Ô∏è EMERGENCY STOP - Set all lights to RED?')) {
            fetch('{% url "camera:emergency_stop" %}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('üö® ' + data.message);
                    updateTrafficStatus();
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function requestPedestrian(direction) {
        fetch('{% url "camera:request_pedestrian_crossing" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ direction: direction })
        })
        .then(response => response.json())
        .then(data => {
            // Show a toast or notification instead of alert
            console.log(data.message);
        })
        .catch(error => console.error('Error:', error));
    }

    // Initialize
    window.addEventListener('load', () => {
        initChart();
        updateTrafficStatus();
        updateEventLog();
        
        // Update every 2 seconds
        setInterval(updateTrafficStatus, 2000);
        setInterval(updateEventLog, 5000);
    });
</script>
{% endblock %}
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .event-log {
            max-height: 300px;
            overflow-y: auto;
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a2e;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .event-time {
            color: #888;
            font-size: 0.9em;
        }

        .event-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .event-type.system { background: #17a2b8; }
        .event-type.pedestrian { background: #ffc107; color: #000; }
        .event-type.transition { background: #28a745; }
        .event-type.emergency { background: #dc3545; }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-info { background: #17a2b8; color: white; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .droidcam-setup {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .droidcam-setup input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #1a1a2e;
            color: #eee;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .video-grid { grid-template-columns: 1fr; }
            .traffic-lights { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¶ Smart Traffic Light System</h1>
            <p>Real-time Intelligent Traffic Control | Raspberry Pi 5 & 4</p>
        </div>

        <!-- System Status -->
        <div class="grid">
            <div class="card">
                <h2>üìä System Status</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Mode</div>
                        <div class="stat-value" id="systemMode">AUTO</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Active Direction</div>
                        <div class="stat-value" id="activeDirection">NORTH</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Vehicles</div>
                        <div class="stat-value" id="totalVehicles">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="detectorFPS">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üéõÔ∏è Control Panel</h2>
                <div class="controls">
                    <button class="btn btn-primary" onclick="toggleMode()">
                        <span id="modeBtn">Switch to MANUAL</span>
                    </button>
                    <button class="btn btn-success" onclick="toggleDetection()" id="detectionBtn">
                        Enable Detection
                    </button>
                    <button class="btn btn-danger" onclick="emergencyStop()">
                        üö® EMERGENCY STOP
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Feeds -->
        <div class="video-grid">
            <div class="card">
                <h2>üìπ Camera Module 3 (Pi 5)</h2>
                <div class="video-container">
                    <div class="video-label">Primary Camera</div>
                    <img id="mainCamera" src="{% url 'camera:video_feed' %}" alt="Main Camera">
                </div>
            </div>

            <div class="card">
                <h2>üì± DroidCam (Smartphone)</h2>
                <div class="droidcam-setup" id="droidcamSetup">
                    <input type="text" id="droidcamURL" 
                           placeholder="http://192.168.1.100:4747/mjpegfeed"
                           value="http://192.168.1.100:4747/mjpegfeed">
                    <button class="btn btn-primary" onclick="startDroidCam()">
                        Connect DroidCam
                    </button>
                    <p style="margin-top: 10px; color: #aaa; font-size: 0.9em;">
                        üì± Install DroidCam app on your smartphone and enter the stream URL above
                    </p>
                </div>
                <div class="video-container" id="droidcamContainer" style="display: none;">
                    <div class="video-label">Pedestrian Camera</div>
                    <img id="droidCamera" src="" alt="DroidCam">
                </div>
            </div>
        </div>

        <!-- Traffic Lights & Vehicle Counts -->
        <div class="grid">
            <div class="card">
                <h2>üö¶ Traffic Lights Status</h2>
                <div class="traffic-lights">
                    <div class="traffic-light-group">
                        <div class="traffic-light-title">üß≠ NORTH</div>
                        <div class="traffic-light">
                            <div class="light red" id="north-red"></div>
                            <div class="light yellow" id="north-yellow"></div>
                            <div class="light green" id="north-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="north-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('NORTH')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚û°Ô∏è EAST</div>
                        <div class="traffic-light">
                            <div class="light red" id="east-red"></div>
                            <div class="light yellow" id="east-yellow"></div>
                            <div class="light green" id="east-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="east-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('EAST')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚¨áÔ∏è SOUTH</div>
                        <div class="traffic-light">
                            <div class="light red" id="south-red"></div>
                            <div class="light yellow" id="south-yellow"></div>
                            <div class="light green" id="south-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="south-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('SOUTH')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚¨ÖÔ∏è WEST</div>
                        <div class="traffic-light">
                            <div class="light red" id="west-red"></div>
                            <div class="light yellow" id="west-yellow"></div>
                            <div class="light green" id="west-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="west-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('WEST')">
                            üö∂ Pedestrian
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Statistics</h2>
                <canvas id="vehicleChart" height="200"></canvas>
            </div>
        </div>

        <!-- Event Log -->
        <div class="card">
            <h2>üìù Event Log</h2>
            <div class="event-log" id="eventLog">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'AUTO';
        let detectionEnabled = false;
        let vehicleChart = null;
        let vehicleData = {
            NORTH: [],
            EAST: [],
            SOUTH: [],
            WEST: []
        };

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('vehicleChart').getContext('2d');
            vehicleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'NORTH',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'EAST',
                            data: [],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'SOUTH',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'WEST',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#eee' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#eee' },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#eee' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }

        // Update traffic status
        function updateTrafficStatus() {
            fetch('{% url "camera:traffic_status" %}')
                .then(response => response.json())
                .then(data => {
                    // Update system status
                    document.getElementById('systemMode').textContent = data.mode;
                    document.getElementById('activeDirection').textContent = data.current_direction;
                    
                    // Update vehicle counts
                    let total = 0;
                    const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
                    directions.forEach(dir => {
                        const count = data.vehicle_counts[dir] || 0;
                        total += count;
                        document.getElementById(`${dir.toLowerCase()}-count`).textContent = count;
                    });
                    document.getElementById('totalVehicles').textContent = total;

                    // Update FPS
                    if (data.detector) {
                        document.getElementById('detectorFPS').textContent = 
                            Math.round(data.detector.fps);
                        detectionEnabled = data.detector.enabled;
                    }

                    // Update traffic lights
                    updateTrafficLights(data.led_states);

                    // Update chart
                    updateChart(data.vehicle_counts);

                    // Update mode button
                    currentMode = data.mode;
                    document.getElementById('modeBtn').textContent = 
                        data.mode === 'AUTO' ? 'Switch to MANUAL' : 'Switch to AUTO';
                })
                .catch(error => console.error('Error fetching traffic status:', error));
        }

        // Update traffic light indicators
        function updateTrafficLights(ledStates) {
            const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
            
            directions.forEach(dir => {
                const state = ledStates[dir] || 'RED';
                const dirLower = dir.toLowerCase();
                
                // Reset all lights
                ['red', 'yellow', 'green'].forEach(color => {
                    document.getElementById(`${dirLower}-${color}`).classList.remove('active');
                });
                
                // Activate appropriate light(s)
                if (state === 'RED') {
                    document.getElementById(`${dirLower}-red`).classList.add('active');
                } else if (state === 'YELLOW') {
                    document.getElementById(`${dirLower}-yellow`).classList.add('active');
                } else if (state === 'GREEN') {
                    document.getElementById(`${dirLower}-green`).classList.add('active');
                } else if (state === 'RED_YELLOW') {
                    document.getElementById(`${dirLower}-red`).classList.add('active');
                    document.getElementById(`${dirLower}-yellow`).classList.add('active');
                }
            });
        }

        // Update chart
        function updateChart(vehicleCounts) {
            if (!vehicleChart) return;

            const now = new Date().toLocaleTimeString();
            
            // Add new data point
            if (vehicleChart.data.labels.length > 20) {
                vehicleChart.data.labels.shift();
                vehicleChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            vehicleChart.data.labels.push(now);
            vehicleChart.data.datasets[0].data.push(vehicleCounts.NORTH || 0);
            vehicleChart.data.datasets[1].data.push(vehicleCounts.EAST || 0);
            vehicleChart.data.datasets[2].data.push(vehicleCounts.SOUTH || 0);
            vehicleChart.data.datasets[3].data.push(vehicleCounts.WEST || 0);
            
            vehicleChart.update('none'); // Update without animation for performance
        }

        // Update event log
        function updateEventLog() {
            fetch('{% url "camera:event_log" %}?limit=20')
                .then(response => response.json())
                .then(data => {
                    const eventLog = document.getElementById('eventLog');
                    eventLog.innerHTML = '';
                    
                    if (data.events && data.events.length > 0) {
                        data.events.reverse().forEach(event => {
                            const eventItem = document.createElement('div');
                            eventItem.className = 'event-item';
                            eventItem.innerHTML = `
                                <span class="event-time">${event.timestamp}</span>
                                <span class="event-type ${event.type.toLowerCase()}">${event.type}</span>
                                <div>${event.message}</div>
                            `;
                            eventLog.appendChild(eventItem);
                        });
                    } else {
                        eventLog.innerHTML = '<div class="loading">No events yet</div>';
                    }
                })
                .catch(error => console.error('Error fetching events:', error));
        }

        // Toggle mode
        function toggleMode() {
            const newMode = currentMode === 'AUTO' ? 'MANUAL' : 'AUTO';
            
            fetch('{% url "camera:set_traffic_mode" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: newMode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Mode changed to ${newMode}`);
                    updateTrafficStatus();
                }
            })
            .catch(error => console.error('Error toggling mode:', error));
        }

        // Toggle detection
        function toggleDetection() {
            fetch('{% url "camera:toggle_detection" %}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    updateTrafficStatus();
                })
                .catch(error => console.error('Error toggling detection:', error));
        }

        // Emergency stop
        function emergencyStop() {
            if (confirm('‚ö†Ô∏è EMERGENCY STOP - Set all lights to RED?')) {
                fetch('{% url "camera:emergency_stop" %}', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert('üö® ' + data.message);
                        updateTrafficStatus();
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Request pedestrian crossing
        function requestPedestrian(direction) {
            fetch('{% url "camera:request_pedestrian_crossing" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            .catch(error => console.error('Error:', error));
        }

        // Start DroidCam
        function startDroidCam() {
            const url = document.getElementById('droidcamURL').value;
            
            fetch('{% url "camera:start_droidcam" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('droidcamSetup').style.display = 'none';
                    document.getElementById('droidcamContainer').style.display = 'flex';
                    document.getElementById('droidCamera').src = '{% url "camera:droidcam_feed" %}';
                    alert('‚úÖ DroidCam connected!');
                } else {
                    alert('‚ùå ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Failed to connect DroidCam');
            });
        }

        // Initialize
        window.addEventListener('load', () => {
            initChart();
            updateTrafficStatus();
            updateEventLog();
            
            // Update every 2 seconds
            setInterval(updateTrafficStatus, 2000);
            
            // Update events every 5 seconds
            setInterval(updateEventLog, 5000);
        });
    </script>
</body>
</html>
