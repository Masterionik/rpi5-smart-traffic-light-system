{% extends 'camera/base.html' %}

{% block title %}Dashboard - Smart Traffic Light System{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    <p>Real-time traffic monitoring and control system</p>
</div>

<!-- Stats Overview -->
<div class="grid-4" style="margin-bottom: 25px;">
    <div class="stat-box">
        <div class="stat-icon primary">
            <i class="fas fa-cog"></i>
        </div>
        <div class="stat-label">System Mode</div>
        <div class="stat-value" id="systemMode">AUTO</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon success">
            <i class="fas fa-compass"></i>
        </div>
        <div class="stat-label">Active Direction</div>
        <div class="stat-value" id="activeDirection">NORTH</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon warning">
            <i class="fas fa-car"></i>
        </div>
        <div class="stat-label">Total Vehicles</div>
        <div class="stat-value" id="totalVehicles">0</div>
    </div>
    <div class="stat-box">
        <div class="stat-icon danger">
            <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="stat-label">Detector FPS</div>
        <div class="stat-value" id="detectorFPS">0</div>
    </div>
</div>

<!-- Camera Feeds Side by Side -->
<div class="grid-2" style="margin-bottom: 25px;">
    <!-- Primary Camera (RPi) -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-video"></i>
                RPi Camera (Vehicle Detection)
            </div>
            <span class="badge badge-success" id="cameraBadge">
                <i class="fas fa-circle"></i> Live
            </span>
        </div>
        <div class="video-container" style="min-height: 280px;">
            <div class="video-label">
                <i class="fas fa-camera"></i> Camera Module 3
            </div>
            <img id="mainCamera" src="{% url 'camera:video_feed' %}" alt="Main Camera" 
                 style="width: 100%; height: auto;"
                 onerror="this.style.display='none'; document.getElementById('cameraPlaceholder').style.display='flex';" 
                 onload="this.style.display='block'; document.getElementById('cameraPlaceholder').style.display='none';">
            <div id="cameraPlaceholder" style="display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: var(--text-secondary);">
                <i class="fas fa-video-slash" style="font-size: 48px;"></i>
                <p style="margin-top: 15px;">Camera not available</p>
            </div>
        </div>
        <!-- Direction counts under RPi camera -->
        <div style="padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <div class="direction-count">
                <i class="fas fa-arrow-up"></i>
                <span class="count" id="north-count">0</span>
                <span class="label">NORTH</span>
            </div>
            <div class="direction-count">
                <i class="fas fa-arrow-right"></i>
                <span class="count" id="east-count">0</span>
                <span class="label">EAST</span>
            </div>
            <div class="direction-count">
                <i class="fas fa-arrow-down"></i>
                <span class="count" id="south-count">0</span>
                <span class="label">SOUTH</span>
            </div>
            <div class="direction-count">
                <i class="fas fa-arrow-left"></i>
                <span class="count" id="west-count">0</span>
                <span class="label">WEST</span>
            </div>
        </div>
    </div>

    <!-- DroidCam (Smartphone Camera) -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-mobile-alt"></i>
                DroidCam (Pedestrian Mode)
            </div>
            <span class="badge" id="droidcamBadge" style="background: var(--danger);">
                <i class="fas fa-circle"></i> Disconnected
            </span>
        </div>
        <div class="video-container" style="min-height: 280px; position: relative;">
            <div class="video-label" style="background: var(--warning);">
                <i class="fas fa-walking"></i> Pedestrian Detection
            </div>
            <img id="droidcamFeed" alt="DroidCam" 
                 style="width: 100%; height: auto; display: none;"
                 onerror="this.style.display='none'; document.getElementById('droidcamPlaceholder').style.display='flex';" 
                 onload="this.style.display='block'; document.getElementById('droidcamPlaceholder').style.display='none';">
            <div id="droidcamPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: var(--text-secondary);">
                <i class="fas fa-mobile-alt" style="font-size: 48px;"></i>
                <p style="margin-top: 15px;">DroidCam not connected</p>
                <p style="font-size: 12px;">Enter URL below to connect</p>
            </div>
        </div>
        <!-- DroidCam Controls -->
        <div style="padding: 15px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="droidcamUrl" placeholder="http://192.168.0.x:4747/video" 
                       style="flex: 1; padding: 10px; border-radius: 8px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary);">
                <button class="btn btn-primary" onclick="connectDroidCam()">
                    <i class="fas fa-plug"></i> Connect
                </button>
            </div>
            
            <!-- Camera Transform Controls -->
            <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                <button class="btn btn-sm" id="droidcamFlipH" onclick="toggleDroidCamFlip('horizontal')" 
                        style="padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color);" 
                        title="Flip Horizontal">
                    <i class="fas fa-arrows-alt-h"></i> Flip H
                </button>
                <button class="btn btn-sm" id="droidcamFlipV" onclick="toggleDroidCamFlip('vertical')" 
                        style="padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color);" 
                        title="Flip Vertical">
                    <i class="fas fa-arrows-alt-v"></i> Flip V
                </button>
                <select id="droidcamRotation" onchange="setDroidCamRotation(this.value)" 
                        style="padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <option value="0">0Â°</option>
                    <option value="90">90Â°</option>
                    <option value="180">180Â°</option>
                    <option value="270">270Â°</option>
                </select>
            </div>
            
            <!-- Pedestrian Phone Mode Toggle -->
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-input); border-radius: 10px;">
                <div>
                    <div style="font-weight: 600; color: var(--text-primary);">
                        <i class="fas fa-walking" style="color: var(--warning);"></i> Pedestrian Phone Mode
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary);">
                        When DroidCam sees cars â†’ Auto RED for cars (pedestrian crosses)
                    </div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="pedestrianModeToggle" onchange="togglePedestrianMode()">
                    <span class="slider round"></span>
                </label>
            </div>
            <div id="pedestrianModeStatus" style="margin-top: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-secondary);">Cars Detected:</span>
                    <span id="droidcamCarCount" style="font-size: 24px; font-weight: bold; color: var(--warning);">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LED Traffic Light (Full Width) -->
<div class="card" style="margin-bottom: 25px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-traffic-light"></i>
            LED Traffic Light (8 LEDs)
        </div>
        <span class="badge" id="ledStateBadge" style="background: var(--danger);">RED</span>
    </div>
    
    <div style="padding: 20px;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
            
            <!-- LED Strip Representation -->
            <div class="led-strip-container">
                <div class="led-strip-label">8-LED Traffic Light Strip</div>
                <div class="led-strip">
                    <!-- RED Section (LEDs 0-2) -->
                    <div class="led-segment red-segment">
                        <div class="led" id="led-0"></div>
                        <div class="led" id="led-1"></div>
                        <div class="led" id="led-2"></div>
                        <span class="segment-label">RED</span>
                    </div>
                    <!-- YELLOW Section (LEDs 3-4) -->
                    <div class="led-segment yellow-segment">
                        <div class="led" id="led-3"></div>
                        <div class="led" id="led-4"></div>
                        <span class="segment-label">YELLOW</span>
                    </div>
                    <!-- GREEN Section (LEDs 5-7) -->
                    <div class="led-segment green-segment">
                        <div class="led" id="led-5"></div>
                        <div class="led" id="led-6"></div>
                        <div class="led" id="led-7"></div>
                        <span class="segment-label">GREEN</span>
                    </div>
                </div>
            </div>

            <!-- Detection Status -->
            <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; font-weight: 700; color: var(--text-primary);" id="vehicleCountDisplay">0</div>
                    <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Vehicles Detected</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 48px; font-weight: 700;" id="ledStateDisplay">ðŸ”´</div>
                    <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Current State</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Control Panel & Chart -->
<div class="grid-2">
    <!-- Control Panel -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-sliders-h"></i>
                Control Panel
            </div>
        </div>
        
        <!-- Mode Selector -->
        <div style="padding: 15px; background: var(--bg-input); border-radius: 12px; margin-bottom: 15px;">
            <h4 style="margin-bottom: 12px; color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">
                <i class="fas fa-cogs"></i> Control Mode
            </h4>
            <div class="mode-selector">
                <button class="mode-btn active" id="modeSimple" onclick="setMode('SIMPLE')">
                    <i class="fas fa-bolt"></i>
                    <span>SIMPLE</span>
                    <small>Instant Response</small>
                </button>
                <button class="mode-btn" id="modeAuto" onclick="setMode('AUTO')">
                    <i class="fas fa-sync-alt"></i>
                    <span>AUTO</span>
                    <small>Intelligent Cycling</small>
                </button>
                <button class="mode-btn" id="modeManual" onclick="setMode('MANUAL')">
                    <i class="fas fa-hand-pointer"></i>
                    <span>MANUAL</span>
                    <small>Direct Control</small>
                </button>
            </div>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            <button class="btn btn-success" onclick="toggleDetection()" id="detectionBtn">
                <i class="fas fa-eye"></i>
                Enable Detection
            </button>
            <button class="btn btn-danger" onclick="emergencyStop()">
                <i class="fas fa-exclamation-triangle"></i>
                Emergency Stop
            </button>
            <button class="btn btn-warning" onclick="requestPedestrian('NORTH')">
                <i class="fas fa-walking"></i>
                Pedestrian Request
            </button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: var(--bg-input); border-radius: 12px;">
            <h4 style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px; text-transform: uppercase;">
                Quick Info
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                <div>
                    <span style="color: var(--text-secondary);">LED Status:</span>
                    <span id="ledStatus" class="badge badge-success" style="margin-left: 5px;">Active</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">Detection:</span>
                    <span id="detectionStatus" class="badge badge-danger" style="margin-left: 5px;">Off</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">DroidCam:</span>
                    <span id="droidcamStatus" class="badge badge-danger" style="margin-left: 5px;">Disconnected</span>
                </div>
                <div>
                    <span style="color: var(--text-secondary);">DB Events:</span>
                    <span id="dbEventCount" style="font-weight: 600;">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Chart -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-chart-area"></i>
                Vehicle Count History
            </div>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="vehicleChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Events (Compact) -->
<div class="card" style="margin-top: 25px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-history"></i>
            Recent Events
        </div>
        <a href="{% url 'camera:analytics' %}" class="btn btn-outline" style="padding: 8px 16px; font-size: 12px;">
            View All <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    <div class="log-container" id="eventLog" style="max-height: 200px;">
        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
            <i class="fas fa-spinner fa-spin"></i> Loading events...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentMode = 'AUTO';
    let detectionEnabled = false;
    let vehicleChart = null;
    let maxDataPoints = 20;

    // Initialize Chart
    function initChart() {
        const ctx = document.getElementById('vehicleChart').getContext('2d');
        vehicleChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'NORTH',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'EAST',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'SOUTH',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'WEST',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { 
                            color: '#a0aec0',
                            usePointStyle: true,
                            boxWidth: 8,
                            font: { size: 11 }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#a0aec0', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    x: {
                        ticks: { 
                            color: '#a0aec0', 
                            font: { size: 10 },
                            maxRotation: 0,
                            maxTicksLimit: 8
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Update traffic status
    function updateTrafficStatus() {
        fetch('{% url "camera:traffic_status" %}')
            .then(response => response.json())
            .then(data => {
                // Update system status
                document.getElementById('systemMode').textContent = data.mode;
                document.getElementById('activeDirection').textContent = data.current_direction;
                
                // Update vehicle counts
                let total = 0;
                const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
                directions.forEach(dir => {
                    const count = data.vehicle_counts[dir] || 0;
                    total += count;
                    document.getElementById(`${dir.toLowerCase()}-count`).textContent = count;
                });
                document.getElementById('totalVehicles').textContent = total;

                // Update FPS and detection
                if (data.detector) {
                    document.getElementById('detectorFPS').textContent = Math.round(data.detector.fps);
                    detectionEnabled = data.detector.enabled;
                    
                    const detectionStatus = document.getElementById('detectionStatus');
                    if (detectionEnabled) {
                        detectionStatus.className = 'badge badge-success';
                        detectionStatus.textContent = 'Active';
                        document.getElementById('detectionBtn').innerHTML = '<i class="fas fa-eye-slash"></i> Disable Detection';
                    } else {
                        detectionStatus.className = 'badge badge-danger';
                        detectionStatus.textContent = 'Off';
                        document.getElementById('detectionBtn').innerHTML = '<i class="fas fa-eye"></i> Enable Detection';
                    }
                }

                // Update LED strip visualization
                updateLEDStrip(data.led_state || data.current_state || 'RED');
                
                // Update vehicle count display
                document.getElementById('vehicleCountDisplay').textContent = data.total_vehicles || total;

                // Update chart (limited data points)
                updateChart(data.vehicle_counts);

                // Update mode selector
                currentMode = data.mode;
                updateModeSelector(data.mode);
            })
            .catch(error => console.error('Error fetching traffic status:', error));
    }

    // Update LED strip visualization (8 LEDs: 3 RED, 2 YELLOW, 3 GREEN)
    function updateLEDStrip(state) {
        state = state.toUpperCase();
        
        // Reset all LEDs
        for (let i = 0; i < 8; i++) {
            const led = document.getElementById(`led-${i}`);
            if (led) {
                led.classList.remove('red-on', 'yellow-on', 'green-on');
            }
        }
        
        // Update state badge
        const badge = document.getElementById('ledStateBadge');
        const stateDisplay = document.getElementById('ledStateDisplay');
        
        if (state === 'RED') {
            // Light up first 3 LEDs (RED section)
            for (let i = 0; i <= 2; i++) {
                document.getElementById(`led-${i}`).classList.add('red-on');
            }
            badge.style.background = 'var(--danger)';
            badge.textContent = 'RED - STOP';
            stateDisplay.textContent = 'ðŸ”´';
        } else if (state === 'YELLOW') {
            // Light up middle 2 LEDs (YELLOW section)
            for (let i = 3; i <= 4; i++) {
                document.getElementById(`led-${i}`).classList.add('yellow-on');
            }
            badge.style.background = 'var(--warning)';
            badge.textContent = 'YELLOW - CAUTION';
            stateDisplay.textContent = 'ðŸŸ¡';
        } else if (state === 'GREEN') {
            // Light up last 3 LEDs (GREEN section)
            for (let i = 5; i <= 7; i++) {
                document.getElementById(`led-${i}`).classList.add('green-on');
            }
            badge.style.background = 'var(--success)';
            badge.textContent = 'GREEN - GO';
            stateDisplay.textContent = 'ðŸŸ¢';
        } else if (state === 'RED_YELLOW') {
            // Light up RED + YELLOW sections
            for (let i = 0; i <= 2; i++) {
                document.getElementById(`led-${i}`).classList.add('red-on');
            }
            for (let i = 3; i <= 4; i++) {
                document.getElementById(`led-${i}`).classList.add('yellow-on');
            }
            badge.style.background = 'linear-gradient(90deg, var(--danger), var(--warning))';
            badge.textContent = 'RED+YELLOW - PREPARE';
            stateDisplay.textContent = 'ðŸŸ ';
        }
    }

    // Update mode selector buttons
    function updateModeSelector(mode) {
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'SIMPLE') {
            document.getElementById('modeSimple').classList.add('active');
        } else if (mode === 'AUTO') {
            document.getElementById('modeAuto').classList.add('active');
        } else if (mode === 'MANUAL') {
            document.getElementById('modeManual').classList.add('active');
        }
    }

    // Set mode
    function setMode(mode) {
        fetch('{% url "camera:set_traffic_mode" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentMode = mode;
                updateModeSelector(mode);
                updateTrafficStatus();
            }
        })
        .catch(error => console.error('Error setting mode:', error));
    }

    // Update chart with fixed data points
    function updateChart(vehicleCounts) {
        if (!vehicleChart) return;

        const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        // Add new data point
        vehicleChart.data.labels.push(now);
        vehicleChart.data.datasets[0].data.push(vehicleCounts.NORTH || 0);
        vehicleChart.data.datasets[1].data.push(vehicleCounts.EAST || 0);
        vehicleChart.data.datasets[2].data.push(vehicleCounts.SOUTH || 0);
        vehicleChart.data.datasets[3].data.push(vehicleCounts.WEST || 0);

        // Keep only last N points
        while (vehicleChart.data.labels.length > maxDataPoints) {
            vehicleChart.data.labels.shift();
            vehicleChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        vehicleChart.update('none');
    }

    // Update event log
    function updateEventLog() {
        fetch('{% url "camera:event_log" %}?limit=10')
            .then(response => response.json())
            .then(data => {
                const eventLog = document.getElementById('eventLog');
                
                if (data.events && data.events.length > 0) {
                    eventLog.innerHTML = data.events.reverse().map(event => {
                        const iconClass = getEventIcon(event.type);
                        return `
                            <div class="log-entry ${event.type.toLowerCase()}">
                                <div class="log-icon ${event.type.toLowerCase()}">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div class="log-content">
                                    <div class="log-time">${event.timestamp}</div>
                                    <div class="log-message">${event.message}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    eventLog.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-secondary);">No events yet</div>';
                }
            })
            .catch(error => console.error('Error fetching events:', error));
    }

    function getEventIcon(type) {
        const icons = {
            'system': 'fa-cog',
            'pedestrian': 'fa-walking',
            'transition': 'fa-exchange-alt',
            'emergency': 'fa-exclamation-triangle',
            'car': 'fa-car',
            'led': 'fa-lightbulb',
            'led_change': 'fa-lightbulb'
        };
        return icons[type.toLowerCase()] || 'fa-info-circle';
    }

    function toggleDetection() {
        fetch('{% url "camera:toggle_detection" %}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                updateTrafficStatus();
            })
            .catch(error => console.error('Error toggling detection:', error));
    }

    function emergencyStop() {
        if (confirm('âš ï¸ EMERGENCY STOP - Set all lights to RED?')) {
            fetch('{% url "camera:emergency_stop" %}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('ðŸš¨ ' + data.message);
                    updateTrafficStatus();
                })
                .catch(error => console.error('Error:', error));
        }
    }

    function requestPedestrian(direction) {
        fetch('{% url "camera:request_pedestrian_crossing" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ direction: direction })
        })
        .then(response => response.json())
        .then(data => {
            // Show a toast or notification instead of alert
            console.log(data.message);
        })
        .catch(error => console.error('Error:', error));
    }

    // ========== DroidCam Functions ==========
    let droidcamConnected = false;
    let pedestrianModeEnabled = false;
    let pedestrianModeInterval = null;
    let droidcamSettings = {
        flipHorizontal: false,
        flipVertical: false,
        rotation: 0
    };

    // Load saved DroidCam settings on page load
    function loadDroidCamSettings() {
        fetch('{% url "camera:get_droidcam_settings" %}')
            .then(response => response.json())
            .then(data => {
                // Load URL
                if (data.droidcam_url) {
                    document.getElementById('droidcamUrl').value = data.droidcam_url;
                }
                
                // Load transform settings
                droidcamSettings.flipHorizontal = data.droidcam_flip_horizontal || false;
                droidcamSettings.flipVertical = data.droidcam_flip_vertical || false;
                droidcamSettings.rotation = data.droidcam_rotation || 0;
                
                // Update UI buttons
                updateFlipButtons();
                document.getElementById('droidcamRotation').value = droidcamSettings.rotation;
                
                // Apply transforms to feed
                applyDroidCamTransforms();
                
                // Load pedestrian mode state
                if (data.pedestrian_phone_mode_enabled) {
                    document.getElementById('pedestrianModeToggle').checked = true;
                    togglePedestrianMode();
                }
                
                // Auto-reconnect if URL was saved and droidcam was enabled
                if (data.droidcam_url && data.droidcam_enabled) {
                    console.log('Auto-reconnecting to saved DroidCam URL...');
                    connectDroidCam();
                }
            })
            .catch(error => console.error('Error loading DroidCam settings:', error));
    }

    function saveDroidCamSettings() {
        const url = document.getElementById('droidcamUrl').value.trim();
        fetch('{% url "camera:save_droidcam_settings" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                droidcam_url: url,
                droidcam_enabled: droidcamConnected,
                droidcam_flip_horizontal: droidcamSettings.flipHorizontal,
                droidcam_flip_vertical: droidcamSettings.flipVertical,
                droidcam_rotation: droidcamSettings.rotation,
                pedestrian_phone_mode_enabled: pedestrianModeEnabled
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('DroidCam settings saved:', data);
        })
        .catch(error => console.error('Error saving DroidCam settings:', error));
    }

    function toggleDroidCamFlip(direction) {
        if (direction === 'horizontal') {
            droidcamSettings.flipHorizontal = !droidcamSettings.flipHorizontal;
        } else {
            droidcamSettings.flipVertical = !droidcamSettings.flipVertical;
        }
        updateFlipButtons();
        applyDroidCamTransforms();
        saveDroidCamSettings();
    }

    function setDroidCamRotation(value) {
        droidcamSettings.rotation = parseInt(value);
        applyDroidCamTransforms();
        saveDroidCamSettings();
    }

    function updateFlipButtons() {
        const btnH = document.getElementById('droidcamFlipH');
        const btnV = document.getElementById('droidcamFlipV');
        
        if (droidcamSettings.flipHorizontal) {
            btnH.style.background = 'var(--primary)';
            btnH.style.color = 'white';
        } else {
            btnH.style.background = 'var(--bg-input)';
            btnH.style.color = 'var(--text-primary)';
        }
        
        if (droidcamSettings.flipVertical) {
            btnV.style.background = 'var(--primary)';
            btnV.style.color = 'white';
        } else {
            btnV.style.background = 'var(--bg-input)';
            btnV.style.color = 'var(--text-primary)';
        }
    }

    function applyDroidCamTransforms() {
        const feed = document.getElementById('droidcamFeed');
        let transform = '';
        
        if (droidcamSettings.flipHorizontal) {
            transform += 'scaleX(-1) ';
        }
        if (droidcamSettings.flipVertical) {
            transform += 'scaleY(-1) ';
        }
        if (droidcamSettings.rotation !== 0) {
            transform += `rotate(${droidcamSettings.rotation}deg) `;
        }
        
        feed.style.transform = transform.trim();
    }

    function connectDroidCam() {
        const url = document.getElementById('droidcamUrl').value.trim();
        if (!url) {
            alert('Please enter DroidCam URL (e.g., http://192.168.0.x:4747/video)');
            return;
        }

        // Show connecting state
        const badge = document.getElementById('droidcamBadge');
        badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
        badge.style.background = 'var(--warning)';

        fetch('{% url "camera:start_droidcam" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                droidcamConnected = true;
                badge.innerHTML = '<i class="fas fa-circle"></i> Connected';
                badge.style.background = 'var(--success)';
                
                // Show the feed
                document.getElementById('droidcamFeed').src = '{% url "camera:droidcam_feed" %}';
                document.getElementById('droidcamFeed').style.display = 'block';
                document.getElementById('droidcamPlaceholder').style.display = 'none';
                
                // Apply saved transforms
                applyDroidCamTransforms();
                
                // Save settings (including URL)
                saveDroidCamSettings();
                
                // Update Quick Info
                document.getElementById('droidcamStatus').className = 'badge badge-success';
                document.getElementById('droidcamStatus').textContent = 'Connected';
            } else {
                droidcamConnected = false;
                badge.innerHTML = '<i class="fas fa-times"></i> Failed';
                badge.style.background = 'var(--danger)';
                alert('Failed to connect: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            badge.innerHTML = '<i class="fas fa-times"></i> Error';
            badge.style.background = 'var(--danger)';
            console.error('DroidCam connection error:', error);
        });
    }

    function togglePedestrianMode() {
        pedestrianModeEnabled = document.getElementById('pedestrianModeToggle').checked;
        const statusDiv = document.getElementById('pedestrianModeStatus');
        
        if (pedestrianModeEnabled) {
            statusDiv.style.display = 'block';
            
            // Start polling DroidCam for car detection
            if (pedestrianModeInterval) clearInterval(pedestrianModeInterval);
            pedestrianModeInterval = setInterval(checkDroidCamCars, 1000);
            
            console.log('Pedestrian Phone Mode enabled - will trigger RED for cars when phone detects vehicles');
        } else {
            statusDiv.style.display = 'none';
            
            // Stop polling
            if (pedestrianModeInterval) {
                clearInterval(pedestrianModeInterval);
                pedestrianModeInterval = null;
            }
        }
        
        // Save pedestrian mode state
        saveDroidCamSettings();
    }

    function checkDroidCamCars() {
        if (!pedestrianModeEnabled || !droidcamConnected) return;

        fetch('{% url "camera:droidcam_pedestrian_mode" %}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('droidcamCarCount').textContent = data.cars_detected || 0;
                
                // If cars detected and mode is active, it will trigger RED automatically on backend
                if (data.triggered) {
                    console.log('Pedestrian crossing triggered - RED for cars');
                }
            })
            .catch(error => console.error('Error checking DroidCam:', error));
    }

    function updateDroidCamStatus() {
        fetch('{% url "camera:droidcam_status" %}')
            .then(response => response.json())
            .then(data => {
                const wasConnected = droidcamConnected;
                droidcamConnected = data.connected || data.running;
                
                const badge = document.getElementById('droidcamBadge');
                const statusBadge = document.getElementById('droidcamStatus');
                
                if (droidcamConnected) {
                    badge.innerHTML = '<i class="fas fa-circle"></i> Connected';
                    badge.style.background = 'var(--success)';
                    statusBadge.className = 'badge badge-success';
                    statusBadge.textContent = 'Connected';
                    
                    // Show feed if just connected
                    if (!wasConnected) {
                        document.getElementById('droidcamFeed').src = '{% url "camera:droidcam_feed" %}';
                        document.getElementById('droidcamFeed').style.display = 'block';
                        document.getElementById('droidcamPlaceholder').style.display = 'none';
                        applyDroidCamTransforms();
                    }
                } else {
                    badge.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                    badge.style.background = 'var(--danger)';
                    statusBadge.className = 'badge badge-danger';
                    statusBadge.textContent = 'Disconnected';
                }
            })
            .catch(error => console.error('Error checking DroidCam status:', error));
    }

    // Initialize
    window.addEventListener('load', () => {
        initChart();
        updateTrafficStatus();
        updateEventLog();
        loadDroidCamSettings();  // Load saved settings first
        updateDroidCamStatus();
        
        // Update every 2 seconds
        setInterval(updateTrafficStatus, 2000);
        setInterval(updateEventLog, 5000);
        setInterval(updateDroidCamStatus, 5000);
    });
</script>

<style>
/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-input);
    transition: .3s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
}

input:checked + .slider {
    background-color: var(--success);
}

input:checked + .slider:before {
    transform: translateX(24px);
}

.slider.round {
    border-radius: 26px;
}

.slider.round:before {
    border-radius: 50%;
}
</style>
{% endblock %}
