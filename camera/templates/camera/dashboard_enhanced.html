<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Light System - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #16213e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 10;
        }

        .traffic-lights {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .traffic-light-group {
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .traffic-light-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .traffic-light {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #555;
            opacity: 0.3;
            transition: opacity 0.3s, box-shadow 0.3s;
        }

        .light.active {
            opacity: 1;
            box-shadow: 0 0 20px currentColor;
        }

        .light.red { background-color: #ff0000; color: #ff0000; }
        .light.yellow { background-color: #ffff00; color: #ffff00; }
        .light.green { background-color: #00ff00; color: #00ff00; }

        .vehicle-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff00;
            margin-top: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .event-log {
            max-height: 300px;
            overflow-y: auto;
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a2e;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .event-time {
            color: #888;
            font-size: 0.9em;
        }

        .event-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .event-type.system { background: #17a2b8; }
        .event-type.pedestrian { background: #ffc107; color: #000; }
        .event-type.transition { background: #28a745; }
        .event-type.emergency { background: #dc3545; }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-info { background: #17a2b8; color: white; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .droidcam-setup {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .droidcam-setup input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #1a1a2e;
            color: #eee;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .video-grid { grid-template-columns: 1fr; }
            .traffic-lights { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¶ Smart Traffic Light System</h1>
            <p>Real-time Intelligent Traffic Control | Raspberry Pi 5 & 4</p>
        </div>

        <!-- System Status -->
        <div class="grid">
            <div class="card">
                <h2>üìä System Status</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Mode</div>
                        <div class="stat-value" id="systemMode">AUTO</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Active Direction</div>
                        <div class="stat-value" id="activeDirection">NORTH</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Vehicles</div>
                        <div class="stat-value" id="totalVehicles">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value" id="detectorFPS">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üéõÔ∏è Control Panel</h2>
                <div class="controls">
                    <button class="btn btn-primary" onclick="toggleMode()">
                        <span id="modeBtn">Switch to MANUAL</span>
                    </button>
                    <button class="btn btn-success" onclick="toggleDetection()" id="detectionBtn">
                        Enable Detection
                    </button>
                    <button class="btn btn-danger" onclick="emergencyStop()">
                        üö® EMERGENCY STOP
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Feeds -->
        <div class="video-grid">
            <div class="card">
                <h2>üìπ Camera Module 3 (Pi 5)</h2>
                <div class="video-container">
                    <div class="video-label">Primary Camera</div>
                    <img id="mainCamera" src="{% url 'camera:video_feed' %}" alt="Main Camera">
                </div>
            </div>

            <div class="card">
                <h2>üì± DroidCam (Smartphone)</h2>
                <div class="droidcam-setup" id="droidcamSetup">
                    <input type="text" id="droidcamURL" 
                           placeholder="http://192.168.1.100:4747/mjpegfeed"
                           value="http://192.168.1.100:4747/mjpegfeed">
                    <button class="btn btn-primary" onclick="startDroidCam()">
                        Connect DroidCam
                    </button>
                    <p style="margin-top: 10px; color: #aaa; font-size: 0.9em;">
                        üì± Install DroidCam app on your smartphone and enter the stream URL above
                    </p>
                </div>
                <div class="video-container" id="droidcamContainer" style="display: none;">
                    <div class="video-label">Pedestrian Camera</div>
                    <img id="droidCamera" src="" alt="DroidCam">
                </div>
            </div>
        </div>

        <!-- Traffic Lights & Vehicle Counts -->
        <div class="grid">
            <div class="card">
                <h2>üö¶ Traffic Lights Status</h2>
                <div class="traffic-lights">
                    <div class="traffic-light-group">
                        <div class="traffic-light-title">üß≠ NORTH</div>
                        <div class="traffic-light">
                            <div class="light red" id="north-red"></div>
                            <div class="light yellow" id="north-yellow"></div>
                            <div class="light green" id="north-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="north-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('NORTH')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚û°Ô∏è EAST</div>
                        <div class="traffic-light">
                            <div class="light red" id="east-red"></div>
                            <div class="light yellow" id="east-yellow"></div>
                            <div class="light green" id="east-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="east-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('EAST')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚¨áÔ∏è SOUTH</div>
                        <div class="traffic-light">
                            <div class="light red" id="south-red"></div>
                            <div class="light yellow" id="south-yellow"></div>
                            <div class="light green" id="south-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="south-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('SOUTH')">
                            üö∂ Pedestrian
                        </button>
                    </div>

                    <div class="traffic-light-group">
                        <div class="traffic-light-title">‚¨ÖÔ∏è WEST</div>
                        <div class="traffic-light">
                            <div class="light red" id="west-red"></div>
                            <div class="light yellow" id="west-yellow"></div>
                            <div class="light green" id="west-green"></div>
                        </div>
                        <div class="vehicle-count">üöó <span id="west-count">0</span> vehicles</div>
                        <button class="btn btn-warning" onclick="requestPedestrian('WEST')">
                            üö∂ Pedestrian
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Statistics</h2>
                <canvas id="vehicleChart" height="200"></canvas>
            </div>
        </div>

        <!-- Event Log -->
        <div class="card">
            <h2>üìù Event Log</h2>
            <div class="event-log" id="eventLog">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'AUTO';
        let detectionEnabled = false;
        let vehicleChart = null;
        let vehicleData = {
            NORTH: [],
            EAST: [],
            SOUTH: [],
            WEST: []
        };

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('vehicleChart').getContext('2d');
            vehicleChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'NORTH',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'EAST',
                            data: [],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'SOUTH',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'WEST',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#eee' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#eee' },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#eee' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }

        // Update traffic status
        function updateTrafficStatus() {
            fetch('{% url "camera:traffic_status" %}')
                .then(response => response.json())
                .then(data => {
                    // Update system status
                    document.getElementById('systemMode').textContent = data.mode;
                    document.getElementById('activeDirection').textContent = data.current_direction;
                    
                    // Update vehicle counts
                    let total = 0;
                    const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
                    directions.forEach(dir => {
                        const count = data.vehicle_counts[dir] || 0;
                        total += count;
                        document.getElementById(`${dir.toLowerCase()}-count`).textContent = count;
                    });
                    document.getElementById('totalVehicles').textContent = total;

                    // Update FPS
                    if (data.detector) {
                        document.getElementById('detectorFPS').textContent = 
                            Math.round(data.detector.fps);
                        detectionEnabled = data.detector.enabled;
                    }

                    // Update traffic lights
                    updateTrafficLights(data.led_states);

                    // Update chart
                    updateChart(data.vehicle_counts);

                    // Update mode button
                    currentMode = data.mode;
                    document.getElementById('modeBtn').textContent = 
                        data.mode === 'AUTO' ? 'Switch to MANUAL' : 'Switch to AUTO';
                })
                .catch(error => console.error('Error fetching traffic status:', error));
        }

        // Update traffic light indicators
        function updateTrafficLights(ledStates) {
            const directions = ['NORTH', 'EAST', 'SOUTH', 'WEST'];
            
            directions.forEach(dir => {
                const state = ledStates[dir] || 'RED';
                const dirLower = dir.toLowerCase();
                
                // Reset all lights
                ['red', 'yellow', 'green'].forEach(color => {
                    document.getElementById(`${dirLower}-${color}`).classList.remove('active');
                });
                
                // Activate appropriate light(s)
                if (state === 'RED') {
                    document.getElementById(`${dirLower}-red`).classList.add('active');
                } else if (state === 'YELLOW') {
                    document.getElementById(`${dirLower}-yellow`).classList.add('active');
                } else if (state === 'GREEN') {
                    document.getElementById(`${dirLower}-green`).classList.add('active');
                } else if (state === 'RED_YELLOW') {
                    document.getElementById(`${dirLower}-red`).classList.add('active');
                    document.getElementById(`${dirLower}-yellow`).classList.add('active');
                }
            });
        }

        // Update chart
        function updateChart(vehicleCounts) {
            if (!vehicleChart) return;

            const now = new Date().toLocaleTimeString();
            
            // Add new data point
            if (vehicleChart.data.labels.length > 20) {
                vehicleChart.data.labels.shift();
                vehicleChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            vehicleChart.data.labels.push(now);
            vehicleChart.data.datasets[0].data.push(vehicleCounts.NORTH || 0);
            vehicleChart.data.datasets[1].data.push(vehicleCounts.EAST || 0);
            vehicleChart.data.datasets[2].data.push(vehicleCounts.SOUTH || 0);
            vehicleChart.data.datasets[3].data.push(vehicleCounts.WEST || 0);
            
            vehicleChart.update('none'); // Update without animation for performance
        }

        // Update event log
        function updateEventLog() {
            fetch('{% url "camera:event_log" %}?limit=20')
                .then(response => response.json())
                .then(data => {
                    const eventLog = document.getElementById('eventLog');
                    eventLog.innerHTML = '';
                    
                    if (data.events && data.events.length > 0) {
                        data.events.reverse().forEach(event => {
                            const eventItem = document.createElement('div');
                            eventItem.className = 'event-item';
                            eventItem.innerHTML = `
                                <span class="event-time">${event.timestamp}</span>
                                <span class="event-type ${event.type.toLowerCase()}">${event.type}</span>
                                <div>${event.message}</div>
                            `;
                            eventLog.appendChild(eventItem);
                        });
                    } else {
                        eventLog.innerHTML = '<div class="loading">No events yet</div>';
                    }
                })
                .catch(error => console.error('Error fetching events:', error));
        }

        // Toggle mode
        function toggleMode() {
            const newMode = currentMode === 'AUTO' ? 'MANUAL' : 'AUTO';
            
            fetch('{% url "camera:set_traffic_mode" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: newMode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Mode changed to ${newMode}`);
                    updateTrafficStatus();
                }
            })
            .catch(error => console.error('Error toggling mode:', error));
        }

        // Toggle detection
        function toggleDetection() {
            fetch('{% url "camera:toggle_detection" %}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    updateTrafficStatus();
                })
                .catch(error => console.error('Error toggling detection:', error));
        }

        // Emergency stop
        function emergencyStop() {
            if (confirm('‚ö†Ô∏è EMERGENCY STOP - Set all lights to RED?')) {
                fetch('{% url "camera:emergency_stop" %}', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert('üö® ' + data.message);
                        updateTrafficStatus();
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Request pedestrian crossing
        function requestPedestrian(direction) {
            fetch('{% url "camera:request_pedestrian_crossing" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            .catch(error => console.error('Error:', error));
        }

        // Start DroidCam
        function startDroidCam() {
            const url = document.getElementById('droidcamURL').value;
            
            fetch('{% url "camera:start_droidcam" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('droidcamSetup').style.display = 'none';
                    document.getElementById('droidcamContainer').style.display = 'flex';
                    document.getElementById('droidCamera').src = '{% url "camera:droidcam_feed" %}';
                    alert('‚úÖ DroidCam connected!');
                } else {
                    alert('‚ùå ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Failed to connect DroidCam');
            });
        }

        // Initialize
        window.addEventListener('load', () => {
            initChart();
            updateTrafficStatus();
            updateEventLog();
            
            // Update every 2 seconds
            setInterval(updateTrafficStatus, 2000);
            
            // Update events every 5 seconds
            setInterval(updateEventLog, 5000);
        });
    </script>
</body>
</html>
